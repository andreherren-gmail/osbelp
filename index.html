<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Monee ‚Äì Budget Chat</title>
  <meta name="theme-color" content="#0b0f17">
  <style>
    :root{
      --bg:#0b0f17;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --brand:#22d3ee;
      --bubble-user:#1f2937;
      --bubble-ai:#0b1220;
      --ring:#22d3ee55;
      --border:#1f2937;
      --money:#22c55e;
      --accent:#22d3ee;
      --warn:#fbbf24;
      --danger:#f87171;
      --ok:#34d399;
      --chip:#0e1a2b; --ok:#065f46; --warnBg:#92400e; --dangerBg:#7f1d1d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#0a0f1a 40%, var(--bg) 100%);color:var(--text)}
    .appbar{position:sticky;top:0;z-index:40;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px env(safe-area-inset-top) 10px;background:rgba(9,13,20,.7);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid #121826}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:26px;height:26px;border-radius:8px;background:radial-gradient(120% 120% at 0% 0%, var(--brand), #60a5fa 60%, #7c3aed)}
    .pill{font-size:12px;color:var(--muted);padding:2px 8px;border:1px solid #223045;border-radius:999px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#0d1524;color:#fff;padding:8px 10px;border-radius:12px;cursor:pointer}
    .btn.ghost{background:transparent}
    .avatar{width:34px;height:34px;border-radius:50%;border:1px solid var(--border);display:grid;place-items:center;background:#0c1426;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .drawer{position:fixed;inset:0 auto 0 0;width:min(86%,360px);background:#0b1220;border-right:1px solid #141c2e;transform:translateX(-100%);transition:.25s transform ease;z-index:60;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer-header{padding:14px;border-bottom:1px solid #141c2e;display:flex;align-items:center;justify-content:space-between}
    .drawer-list{overflow:auto;-webkit-overflow-scrolling:touch;padding:8px 8px 96px}
    .chat-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer;border:1px solid transparent}
    .chat-item:hover{background:#0f172a;border-color:#1f2937}
    .chat-item.active{background:#0f172a;border-color:#283245}
    .wrap{min-height:100%;display:flex;flex-direction:column}
    .chat{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;padding:12px 12px 120px}
    .container{max-width:760px;margin:0 auto}
    .msg{display:flex;gap:10px;margin:12px 0}
    .bubble{padding:12px 14px;border-radius:16px;border:1px solid var(--border);line-height:1.55}
    .msg.user .bubble{background:var(--bubble-user)}
    .msg.ai .bubble{background:var(--bubble-ai)}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}
    .empty{margin:12vh auto 0;max-width:640px;text-align:center;color:var(--muted)}
    .empty h2{color:#e5e7eb;font-size:20px;margin:0 0 8px}
    .tips{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:16px}
    .tip{padding:10px;border:1px dashed #263245;border-radius:12px;color:#cbd5e1;background:linear-gradient(180deg,#0d1526,#0a101c)}
    @media(min-width:720px){.tips{grid-template-columns:repeat(4,1fr)}}
    .composer{position:fixed;left:0;right:0;bottom:0;z-index:40;padding:12px 12px calc(12px + env(safe-area-inset-bottom));background:linear-gradient(180deg, rgba(10,14,22,0), rgba(10,14,22,.85) 30%, rgba(10,14,22,.95));display:grid;place-items:center}
    .composer-inner{width:100%;max-width:780px;display:flex;align-items:flex-end;gap:8px;background:#0c1426;border:1px solid var(--border);border-radius:24px;padding:8px;box-shadow:0 0 0 2px transparent;transition:.15s box-shadow ease,.15s border-color ease}
    .composer-inner:focus-within{box-shadow:0 0 0 2px var(--ring)}
    .icon-btn{display:grid;place-items:center;width:40px;height:40px;border-radius:12px;border:1px solid #1e293b;background:#0a1222;cursor:pointer}
    .hidden-input{display:none}
    textarea{flex:1;resize:none;height:44px;min-height:44px;max-height:44px;overflow:auto;background:transparent;border:none;color:#e5e7eb;font-size:16px;line-height:1.5;outline:none;padding:10px 8px}
    textarea:disabled{opacity:.6;cursor:not-allowed}
    .send-btn{width:44px;height:44px;border-radius:999px;border:1px solid #164e63;background:linear-gradient(180deg,#0e1a2b,#0a1322);display:grid;place-items:center;cursor:pointer;flex:0 0 auto;box-shadow:inset 0 0 0 1px #113246, 0 6px 18px rgba(0,0,0,.3);transition:transform .08s ease, box-shadow .15s ease, border-color .15s ease;color:#a5f3fc}
    .send-btn:hover{transform:translateY(-1px); box-shadow:inset 0 0 0 1px #1e7498, 0 8px 20px rgba(0,0,0,.35)}
    .send-btn:active{transform:translateY(0)}
    .send-btn.disabled{opacity:.5;cursor:not-allowed}
    .send-icon{font-size:18px;line-height:1;transform:translateX(1px)}
    .typing .bubble{display:inline-flex;gap:8px;align-items:center}
    .dollar{display:inline-block;font-weight:700;color:#22c55e;opacity:.2;transform:translateY(0) scale(1);animation:blink .9s infinite}
    .dollar:nth-child(2){animation-delay:.15s}
    .dollar:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%,100%{opacity:.2; transform:translateY(0) scale(1)}50%{opacity:1; transform:translateY(-2px) scale(1.06)}}
    .chart-wrap{margin-top:10px;border:1px solid #1b2740;border-radius:12px;overflow:hidden;background:#0b1220}
    .bubble svg{max-width:100%;height:auto;display:block}
    /* Bottom sheet open state */
    #statusSheet.open{ transform:translateY(0); pointer-events:auto; }

    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid #1f2d44;background:#0e1a2b;font-size:12px;color:#c8e3ff}
    .b-ok{border-color:#1f3d2a} .b-warn{border-color:#664c10} .b-danger{border-color:#5a1a1a}
  </style>
</head>
<body>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-header">
      <strong>Budgets</strong>
      <button class="btn ghost" id="closeDrawer" aria-label="Schliessen">‚úï</button>
    </div>
    <div class="drawer-list" id="chatList"></div>
    <div style="padding:12px;">
      <button class="btn" id="newChatBtn2">Ôºã Neues Budget</button>
    </div>
  </aside>

  <header class="appbar">
    <div class="brand">
      <button class="btn ghost" id="openDrawer" aria-label="Budgets"><span>‚â°</span></button>
      <div class="logo" aria-hidden="true"></div>
      <div class="title">Monee</div>
      <span class="pill" id="activeBudgetPill">Kein Budget</span>
      <span class="pill" id="entryCounter">0/10</span>
    </div>
    <div class="actions">
      <button class="btn" id="newChatBtn">Ôºã Neues Budget</button>
      <button class="btn" id="budgetAlertBtn" style="display:none" title="Budgetstatus">‚ö†Ô∏è</button>
      <button class="avatar" id="avatarBtn" title="Anmelden">
        <img id="avatarImg" alt="" />
        <span id="avatarFallback" aria-hidden="true">üë§</span>
      </button>
    </div>
  </header>

  <main class="wrap">
    <section class="chat">
      <div class="container" id="chatContainer">
        <div class="empty" id="emptyState">
          <h2>Neues Budget im Chat starten</h2>
          <p>Gib z.B. ein: <em>‚ÄûMigros 18.40 #Lebensmittel‚Äú</em> oder lade einen Beleg √ºber <strong>Ôºã</strong> hoch.</p>
          <div class="tips">
            <div class="tip">‚ÄûBudget Mobilit√§t 100‚Äú ‚Äì setzt Budget der Kategorie</div>
            <div class="tip">‚ÄûZeige Budgets‚Äú ‚Äì listet alle Kategorien-Budgets</div>
            <div class="tip">‚ÄûAusgaben Oktober [2025]‚Äú ‚Äì Monatsreport + Chart</div>
            <div class="tip">‚ÄûSetze Kategorie 3 Mobilit√§t‚Äú ‚Äì Eintrag umh√§ngen</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="statusSheet" style="position:fixed;left:0;right:0;bottom:0;z-index:90;background:#0b1220;border-top:1px solid #162238;border-radius:16px 16px 0 0;box-shadow:0 -8px 24px rgba(0,0,0,.35);transform:translateY(100%);transition:transform .25s ease;pointer-events:none;">
    <div style="padding:12px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #142033">
      <strong>Budgetstatus</strong>
      <button class="btn ghost" id="closeStatusSheet">‚úï</button>
    </div>
    <div id="statusSheetBody" style="max-height:40vh;overflow:auto;padding:10px 14px;color:#e5e7eb"></div>
  </div>


  <div class="composer">
    <div class="composer-inner">
      <button class="icon-btn" id="addBtn" title="Beleg/Foto">Ôºã</button>
      <input class="hidden-input" id="fileInput" type="file" accept="image/*" multiple capture="environment">
      <textarea id="input" rows="1" placeholder="Schreibe eine Ausgabe (z.B. ‚ÄûB√§ckerei 4.60 #Food‚Äú) oder ‚ÄûBudget Food 120‚Äú" aria-label="Nachricht" enterkeyhint="newline" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"></textarea>
      <button id="sendBtn" class="send-btn" title="Senden" aria-label="Senden"><span class="send-icon">‚û§</span></button>
    </div>
    <small style="display:block;text-align:center;color:#9ca3af;margin-top:8px">
      Enter: Zeilenumbruch ‚Ä¢ Senden: Button ‚Ä¢ Prototyp speichert lokal (max. 10 Eintr√§ge)
    </small>
  </div>

  <div class="modal" id="authModal" role="dialog" aria-modal="true" aria-labelledby="authTitle" style="position:fixed;inset:0;display:none;place-items:center;z-index:80;background:rgba(5,8,13,.6);backdrop-filter:blur(6px)">
    <div class="card" style="width:min(92vw,420px);background:#0b1220;border:1px solid #1c2436;border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)">
      <h3 id="authTitle">Anmelden</h3>
      <p>Demo-Login (lokal):</p>
      <div class="row" style="display:flex;gap:10px;align-items:center">
        <div class="avatar" style="width:32px;height:32px;display:grid;place-items:center;border:1px solid #1f2937;background:#0c1426;border-radius:50%">üßë‚Äçüíª</div>
        <input id="nameInput" placeholder="Name" style="flex:1;background:#0a1222;border:1px solid #1f2937;border-radius:10px;color:#e5e7eb;padding:8px 10px">
      </div>
      <div class="row" style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" id="cancelAuth">Abbrechen</button>
        <button class="btn" id="confirmAuth">Anmelden</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (q,root=document)=>root.querySelector(q);

    const state = {
      user: JSON.parse(localStorage.getItem('monee_user')||'null'),
      chats: JSON.parse(localStorage.getItem('monee_chats_v4')||'[]'),
      activeId: localStorage.getItem('monee_active') || null,
      pendingBudget: null
    };

    const save = ()=>{
      localStorage.setItem('monee_user', JSON.stringify(state.user));
      localStorage.setItem('monee_chats_v4', JSON.stringify(state.chats));
      localStorage.setItem('monee_active', state.activeId||'');
    };
    const uid = ()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
    const activeChat = ()=> state.chats.find(c=>c.id===state.activeId) || null;
    const fmtDate = (ts)=> new Date(ts).toLocaleString(undefined,{dateStyle:'medium', timeStyle:'short'});
    const escapeHTML = (s)=> s.replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));
    const autolink = (s)=> s.replace(/(https?:\/\/[^\s)]+)|(CHF\s*\d+(?:[\.,]\d{2})?|\d+(?:[\.,]\d{2})?\s*CHF)/gi, '<u>$1$2</u>');

    const COLORS = ['#22d3ee','#60a5fa','#a78bfa','#f472b6','#34d399','#fbbf24','#f87171','#c084fc','#4ade80','#93c5fd'];
    const CAT_KEYWORDS = {
      'lebensmittel':['migros','coop','aldi','lidl','denner','volg','spar','lebensmittel','food','b√§ckerei','boulangerie'],
      'mobilit√§t':['sbb','√∂vn','√∂V','bus','tram','tank','benzin','diesel','tanken','parking','parkhaus','parkgeb√ºhr','velo','e-auto','autobahnvignette'],
      'essen & trinken':['restaurant','caf√©','cafe','bar','mittag','dinner','takeaway','kebab','pizza','mc','bk','starbucks'],
      'wohnen':['miete','nebenkosten','strom','gas','heizung','internet','swisscom','salt','sunrise','wasser','abfall'],
      'freizeit':['kino','freizeit','musee','museen','sport','wellness','bad','schwimmbad','fitness','abo'],
      'gesundheit':['apotheke','arzt','zahnarzt','medik'],
      'kinder':['schule','kita','spielzeug','windeln','kinder','familie'],
      'sonstiges':['diverses','sonstiges','andere','misc']
    };

    // UI refs
    const chatContainer = $('#chatContainer');
    const chatScroller = document.querySelector('.chat');
    const inputEl = $('#input');
    const fileInput = $('#fileInput');
    const addBtn = $('#addBtn');
    const avatarBtn = $('#avatarBtn');
    const authModal = $('#authModal');
    const cancelAuth = $('#cancelAuth');
    const confirmAuth = $('#confirmAuth');
    const nameInput = $('#nameInput');
    const avatarImg = $('#avatarImg');
    const avatarFallback = $('#avatarFallback');
    const openDrawer = $('#openDrawer');
    const closeDrawer = $('#closeDrawer');
    const drawer = $('#drawer');
    const chatList = $('#chatList');
    const newChatBtn = $('#newChatBtn');
    const newChatBtn2 = $('#newChatBtn2');
    const budgetPill = $('#activeBudgetPill');
    const entryCounter = $('#entryCounter');
    const emptyState = $('#emptyState');
    const sendBtn = $('#sendBtn');
    const budgetAlertBtn = $('#budgetAlertBtn');
    const statusSheet = $('#statusSheet');
    const statusSheetBody = $('#statusSheetBody');
    const closeStatusSheet = $('#closeStatusSheet');

    let inputDisabled = false;

    const ensureScroll = ()=>{ chatScroller.scrollTop = chatScroller.scrollHeight; };
    const setInputDisabled = (on)=>{
      inputDisabled = !!on;
      inputEl.disabled = on;
      if(on) sendBtn.classList.add('disabled'); else sendBtn.classList.remove('disabled');
    };
    const focusComposer = ()=>{ if(!inputDisabled){ inputEl.focus(); setTimeout(()=>inputEl.focus(),0); } };

    const updateAvatar = ()=>{
      if(state.user && state.user.photo){
        avatarImg.src = state.user.photo;
        avatarImg.style.display='block';
        avatarFallback.style.display='none';
      }else{
        avatarImg.removeAttribute('src');
        avatarImg.style.display='none';
        avatarFallback.style.display='grid';
      }
    };

    const renderDrawer = ()=>{
      chatList.innerHTML = '';
      if(state.chats.length===0){
        const div = document.createElement('div');
        div.style.color='#9ca3af';
        div.style.padding='12px';
        div.textContent='Noch keine Budgets.';
        chatList.appendChild(div);
        return;
      }
      state.chats.slice().sort((a,b)=>b.createdAt-a.createdAt).forEach(c=>{
        const el = document.createElement('div');
        el.className = 'chat-item'+(c.id===state.activeId?' active':'');
        const entriesCount = (c.entries||[]).length;
        el.innerHTML = ''
          + '<div class="avatar" style="width:30px;height:30px">üí¨</div>'
          + '<div style="flex:1">'
          +   '<div style="font-weight:600">'+escapeHTML(c.title||'Neues Budget')+'</div>'
          +   '<div class="meta" style="color:#9ca3af">'+fmtDate(c.createdAt)+' ‚Ä¢ '+entriesCount+'/10</div>'
          + '</div>'
          + '<button class="btn ghost" data-act="rename" style="padding:6px 8px">‚úé</button>';
        el.addEventListener('click',(e)=>{
          if(e.target.dataset.act==='rename'){
            e.stopPropagation();
            const title = prompt('Budget umbenennen:', c.title||'');
            if(title!=null){ c.title = title.trim()||''; save(); render(); }
            return;
          }
          openChat(c.id); drawer.classList.remove('open');
        });
        chatList.appendChild(el);
      });
    };
    openDrawer.addEventListener('click', ()=>{drawer.classList.add('open'); renderDrawer()});
    closeDrawer.addEventListener('click', ()=>drawer.classList.remove('open'));

    const newChat = ()=>{
      const id = uid();
      state.chats.push({id, title:'', createdAt:Date.now(), msgs:[], entries:[], receipts:[], budgets:{}});
      state.activeId = id;
      save(); render(); focusComposer();
      pushAIWithTyping("Willkommen! Neues Budget erstellt. F√ºge Ausgaben wie *‚ÄûMigros 18.40 #Lebensmittel‚Äú* hinzu. Tippe **Hilfe** f√ºr Befehle.");
    };
    const openChat = (id)=>{ state.activeId = id; save(); render(); };

    newChatBtn.addEventListener('click', newChat);
    newChatBtn2.addEventListener('click', newChat);

    const render = ()=>{
      const chat = activeChat();
      chatContainer.innerHTML = '';
      if(!chat || (chat.msgs.length===0)){
        chatContainer.appendChild(emptyState); emptyState.style.display='block';
      }else{
        emptyState.style.display='none';
        chat.msgs.forEach(m=>{
          const row = document.createElement('div');
          row.className = 'msg '+(m.role==='user'?'user':'ai');
          row.innerHTML = ''
            + '<div class="avatar" style="width:28px;height:28px">' + (m.role==='user'?(state.user?.name?.[0]?.toUpperCase()||'üßë'):'ü§ñ') + '</div>'
            + '<div style="flex:1">'
            +   '<div class="bubble">' + decorateMessageHTML(m.text) + '</div>'
            +   '<div class="meta">' + fmtDate(m.ts) + '</div>'
            +   (m.attachments?.length? '<div class="attachments">' + m.attachments.map(a => '<div class="attachment"><img alt="Beleg" src="'+a.data+'"></div>').join('') + '</div>':'' )
            + '</div>';
          chatContainer.appendChild(row);
        });
      }
      const count = chat ? (chat.entries||[]).length : 0;
      budgetPill.textContent = chat ? (chat.title || 'Unbenanntes Budget') : 'Kein Budget';
      entryCounter.textContent = `${count}/10`;
      renderDrawer();
      ensureScroll();
      updateBudgetPill();
    };

    function decorateMessageHTML(text){
      const isHTML = text.startsWith('<div class="chart-wrap"') || text.startsWith('<svg');
      if(isHTML) return text;
      return autolink(escapeHTML(text)).replace(/\\n/g,'<br>');
    }

    
    function calcActiveBudgetStatus(){
      const chat = activeChat(); if(!chat) return {maxPct:0, alerts:[], hasBudgets:false};
      const budgets = chat.budgets || {};
      const categories = Object.keys(budgets);
      if(categories.length===0) return {maxPct:0, alerts:[], hasBudgets:false};
      const alerts = [];
      let maxPct = 0;
      // compute spent per category
      const spentMap = {};
      (chat.entries||[]).forEach(e=>{
        spentMap[e.category] = (spentMap[e.category]||0) + Number(e.amount||0);
      });
      categories.forEach(cat=>{
        const total = Number(budgets[cat]||0);
        if(total>0){
          const spent = Number(spentMap[cat]||0);
          const pct = spent/total;
          if(pct>=0.8){ alerts.push({cat, pct}); }
          if(pct>maxPct) maxPct = pct;
        }
      });
      alerts.sort((a,b)=>b.pct-a.pct);
      return {maxPct, alerts, hasBudgets:true};
    }

    function openStatusSheet(lines){ statusSheetBody.innerHTML = lines.join('<br>'); statusSheet.classList.add('open'); }
    function closeStatus(){ statusSheet.classList.remove('open'); }

    function updateBudgetPill(){
      const chat = activeChat();
      budgetPill.style.transition = 'background .2s ease, border-color .2s ease, color .2s ease';
      if(!chat){ budgetPill.style.background=''; budgetPill.style.borderColor=''; budgetPill.textContent='Kein Budget'; budgetAlertBtn.style.display='none'; return; }

      const status = calcActiveBudgetStatus();
      const title = chat.title || 'Unbenanntes Budget';
      let bg = ''; let border = '#223045'; let text = title; let showAlert = false;

      if(!status.hasBudgets){
        bg = '#0e1a2b'; text = title; showAlert = false;
      } else if(status.maxPct >= 1.0){
        bg = getComputedStyle(document.documentElement).getPropertyValue('--dangerBg').trim() || '#7f1d1d';
        text = `${title}`; showAlert = true;
      } else if(status.maxPct >= 0.8){
        bg = getComputedStyle(document.documentElement).getPropertyValue('--warnBg').trim() || '#92400e';
        text = `${title}`; showAlert = true;
      } else {
        bg = getComputedStyle(document.documentElement).getPropertyValue('--ok').trim() || '#065f46';
        text = `${title}`; showAlert = false;
      }
      budgetPill.style.background = bg;
      budgetPill.style.borderColor = border;
      budgetPill.style.color = '#e5e7eb';
      budgetPill.textContent = text;

      // Build alert lines for sheet (mobile instead of tooltip)
      if(showAlert && status.alerts.length){
        const lines = status.alerts.map(a=>{
          const pct = Math.round(a.pct*100);
          const icon = (pct>=100)?'üî¥':(pct>=80)?'üü†':'üü¢';
          return `${icon} ${a.cat}: ${pct}%`;
        });
        budgetAlertBtn.style.display='inline-flex';
        budgetAlertBtn.onclick = ()=> openStatusSheet(lines);
      } else {
        budgetAlertBtn.style.display='none';
      }
    }

    const pushUser = (text, attachments=[])=>{
      const chat = activeChat(); if(!chat){ newChat(); return pushUser(text,attachments); }
      chat.msgs.push({role:'user', text, ts:Date.now(), attachments});
      save(); render();
      handleCommandOrEntry(text);
    };
    const pushAI = (text)=>{
      const chat = activeChat(); if(!chat) return;
      chat.msgs.push({role:'ai', text, ts:Date.now()}); save(); render();
    };

    function showTyping(){
      const row = document.createElement('div');
      row.className = 'msg ai typing';
      row.innerHTML = ''
        + '<div class="avatar" style="width:28px;height:28px">ü§ñ</div>'
        + '<div style="flex:1">'
        +   '<div class="bubble"><span class="dollar">$</span><span class="dollar">$</span><span class="dollar">$</span></div>'
        +   '<div class="meta">schreibt‚Ä¶</div>'
        + '</div>';
      chatContainer.appendChild(row);
      ensureScroll();
      return row;
    }
    function pushAIWithTyping(text, delay=600){
      setInputDisabled(true);
      const typingEl = showTyping();
      setTimeout(()=>{
        typingEl.remove();
        pushAI(text);
        setInputDisabled(false);
        focusComposer();
      }, delay);
    }

    function parseCategoryFromText(t){
      const hash = t.match(/#([A-Za-z√Ñ√ñ√ú√§√∂√º√ü &]+)\s*$/);
      if(hash){ return hash[1].trim(); }
      const br = t.match(/\[([^\]]+)\]\s*$/);
      if(br){ return br[1].trim(); }
      const low = t.toLowerCase();
      for(const cat in CAT_KEYWORDS){
        if(CAT_KEYWORDS[cat].some(k=> low.includes(k))) return titleCase(cat);
      }
      return 'Sonstiges';
    }
    function titleCase(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

    function handleCommandOrEntry(text){
      const t = text.trim();
      const low = t.toLowerCase();

      if(state.pendingBudget){
        const val = parseAmountFromText(low);
        if(!isNaN(val)){
          const cat = state.pendingBudget.category;
          state.pendingBudget = null;
          setBudget(cat, val, true);
          return;
        }
      }

      const mShow = low.match(/^zeige (?:eintr[a√§]ge|entries)(?:\s+(\d+))?/);
      const mShowOne = low.match(/^zeige eintrag\s+(\d+)/);
      const mDelete = low.match(/^l[√∂o]sche eintrag\s+(\d+)/);
      const mSum = low.match(/^summe(?:\s+(monat|woche))?/);
      const mHelp = low.match(/^hilfe$/);
      const mCats = low.match(/^zeige kategorien$/);
      const mSumCat = low.match(/^summe nach kategorien?|kategorien?\s*summe$/);
      const mSetCat = low.match(/^setze kategorie\s+(\d+)\s+(.+)$/);
      const mMonth = low.match(/^ausgaben\s+([a-z√§√∂√º\.]+)(?:\s+(\d{4}))?/);
      const mSetBudget = low.match(/^(?:setze budget|budget)\s+(.+?)\s+(\d+[.,]?\d*)$/);
      const mShowBudget = low.match(/^zeige budget(?:\s+(.+))?$/);
      const mDelBudget = low.match(/^l[√∂o]sche budget\s+(.+)$/);

      if(mHelp){ return pushAIWithTyping(helpText()); }
      if(mShow){ const n = parseInt(mShow[1]||'10',10); return pushAIWithTyping(renderEntries(n)); }
      if(mShowOne){ const idx = parseInt(mShowOne[1],10); return pushAIWithTyping(renderEntry(idx)); }
      if(mDelete){ const idx = parseInt(mDelete[1],10); return pushAIWithTyping(deleteEntry(idx)); }
      if(mSum){ return pushAIWithTyping(sumEntries()); }
      if(mCats){ return pushAIWithTyping(listCategories()); }
      if(mSumCat){ return pushAIWithTyping(sumByCategory()); }
      if(mSetCat){ const idx=parseInt(mSetCat[1],10); const cat=titleCase(mSetCat[2].trim()); return pushAIWithTyping(setCategory(idx,cat)); }
      if(mMonth){
        const mName = mMonth[1]; const year = mMonth[2]? parseInt(mMonth[2],10): (new Date()).getFullYear();
        const mi = monthIndexFromGerman(mName);
        if(mi===-1) return pushAIWithTyping('Monat nicht erkannt. Beispiel: **Ausgaben Oktober 2025**');
        return renderMonthSummary(mi, year);
      }
      if(mSetBudget){
        const cat = titleCase(mSetBudget[1].trim());
        const amt = parseAmountFromText(mSetBudget[2]);
        return pushAIWithTyping(setBudget(cat, amt));
      }
      if(mShowBudget){
        const cat = mShowBudget[1] ? titleCase(mShowBudget[1].trim()) : null;
        return pushAIWithTyping(showBudgets(cat));
      }
      if(mDelBudget){
        const cat = titleCase(mDelBudget[1].trim());
        return pushAIWithTyping(deleteBudget(cat));
      }

      const amount = parseAmountFromText(t);
      if(!isNaN(amount)){
        const label = t.replace(String(amount).replace('.',','), '').replace(/\s*(#.+|\[[^\]]+\])\s*$/,'').trim() || 'Ausgabe';
        const category = titleCase(parseCategoryFromText(t));
        return addEntry(label, amount, category);
      }
      return pushAIWithTyping('Verstanden. (Befehl/Betrag nicht erkannt ‚Äì tippe **Hilfe** f√ºr Beispiele)');
    }

    function parseAmountFromText(s){
      const m = String(s).match(/(\d+[.,]\d{1,2}|\d+)/);
      return m ? parseFloat(m[1].replace(',','.')) : NaN;
    }

    function helpText(){
      return [
        'Befehle:',
        '‚Ä¢ **Zeige Eintr√§ge [N]** ‚Äì listet die gespeicherten Eintr√§ge',
        '‚Ä¢ **Zeige Eintrag N** ‚Äì Detailansicht eines Eintrags',
        '‚Ä¢ **L√∂sche Eintrag N** ‚Äì entfernt den Eintrag',
        '‚Ä¢ **Summe / Summe nach Kategorie** ‚Äì Gesamtsumme bzw. gruppiert',
        '‚Ä¢ **Zeige Kategorien** ‚Äì Liste verwendeter Kategorien',
        '‚Ä¢ **Setze Kategorie N <Name>** ‚Äì Kategorie zuweisen',
        '‚Ä¢ **Budget <Kategorie> <Betrag>** ‚Äì Budget setzen (alias: Setze Budget ‚Ä¶)',
        '‚Ä¢ **Zeige Budget [Kategorie]** ‚Äì zeigt Budget(s) & Status',
        '‚Ä¢ **L√∂sche Budget <Kategorie>** ‚Äì entfernt Budget',
        '‚Ä¢ **Ausgaben Oktober [2025]** ‚Äì Monatsreport + Mini-Chart',
        '',
        'Ausgabe hinzuf√ºgen: *‚ÄûMigros 18.40 #Lebensmittel‚Äú* oder *‚ÄûSBB 8.40 [Mobilit√§t]‚Äú*'
      ].join('\\n');
    }

    function ensureBudgets(chat){
      if(!chat.budgets) chat.budgets = {};
    }

    function setBudget(cat, amt, silent=false){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      ensureBudgets(chat);
      if(isNaN(amt) || amt<=0) return 'Bitte g√ºltigen Budgetbetrag angeben (z. B. **Budget Mobilit√§t 120**).';
      chat.budgets[cat] = amt;
      save(); render();
      const spent = sumForCategory(cat);
      const pct = (spent/amt)||0;
      if(silent){ pushAI(`Budget gesetzt: **${cat}** ‚Üí **CHF ${amt.toFixed(2)}**.`); return; }
      return `Budget gesetzt: **${cat}** ‚Üí **CHF ${amt.toFixed(2)}**. Aktuell genutzt: **CHF ${spent.toFixed(2)}** (${Math.round(pct*100)}%).`;
    }

    function showBudgets(cat){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      ensureBudgets(chat);
      const b = chat.budgets;
      const keys = cat ? [cat] : Object.keys(b);
      if(keys.length===0) return 'Es sind noch keine Budgets gesetzt.';
      const lines = keys.map(k=>{
        const total = b[k];
        const spent = sumForCategory(k);
        const pct = total ? Math.round((spent/total)*100) : 0;
        const status = total ? thresholdBadge(spent, total) : '';
        return `${k}: ${total?`CHF ${total.toFixed(2)}`:'‚Äì'} ‚Ä¢ Verbraucht: CHF ${spent.toFixed(2)} ${total?`(${pct}%)`:''} ${status}`.trim();
      });
      return (cat?`Budget **${cat}**:\n`:'Budgets:\n') + lines.join('\\n');
    }

    function deleteBudget(cat){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      ensureBudgets(chat);
      if(!(cat in chat.budgets)) return `F√ºr **${cat}** ist kein Budget gesetzt.`;
      delete chat.budgets[cat];
      save(); render();
      return `Budget gel√∂scht: **${cat}**.`;
    }

    function thresholdBadge(spent, total){
      const pct = total? spent/total : 0;
      if(!total) return '';
      if(pct >= 1.0) return '‚Äî ‚ö†Ô∏è **100%+**';
      if(pct >= 0.8) return '‚Äî ‚ö†Ô∏è **80%**';
      if(pct >= 0.5) return '‚Äî ‚ö†Ô∏è **50%**';
      return '‚Äî ‚úÖ ok';
    }

    function sumForCategory(cat){
      const chat = activeChat(); if(!chat) return 0;
      return (chat.entries||[]).filter(e=>e.category===cat).reduce((s,e)=>s+Number(e.amount||0),0);
    }

    function addEntry(label, amount, category){
      const chat = activeChat(); if(!chat) return;
      chat.entries = chat.entries || [];
      ensureBudgets(chat);

      const prevSpent = sumForCategory(category);
      const prevPct = chat.budgets[category] ? prevSpent / chat.budgets[category] : null;

      const entry = { id: uid(), ts: Date.now(), label, amount, category };
      chat.entries.push(entry);
      if(chat.entries.length>10){ chat.entries = chat.entries.slice(-10); }
      save();

      const left = 10 - chat.entries.length;
      pushAIWithTyping(`Notiert: **${escapeHTML(label)} ‚Äì CHF ${amount.toFixed(2)}**\\nKategorie: ${category}\\nEs sind jetzt **${chat.entries.length}/10** Eintr√§ge gespeichert.${left?` (noch ${left} frei)`:''}`);

      const isFirstInCat = prevSpent === 0;
      if(isFirstInCat && !(category in chat.budgets)){
        state.pendingBudget = {category};
        save();
        setTimeout(()=>{
          pushAI(`M√∂chtest du ein Budget f√ºr **${category}** setzen? Antworte z.‚ÄØB.: **Budget ${category} 100** (oder einfach Betrag schreiben).`);
        }, 650);
      }

      if(category in chat.budgets){
        const total = chat.budgets[category];
        const newSpent = prevSpent + amount;
        const newPct = newSpent / total;
        const crossed = crossedThreshold(prevPct, newPct);
        if(crossed){
          const pctLabel = crossed*100 >= 100 ? '100%+' : `${crossed*100}%`;
          const remaining = Math.max(0, total - newSpent);
          const badge = crossed >= 1 ? 'b-danger' : crossed >= 0.8 ? 'b-warn' : 'b-ok';
          pushAI(`Status **${category}**: ‚ö†Ô∏è Grenze ${pctLabel} erreicht ‚Ä¢ Verbraucht: **CHF ${newSpent.toFixed(2)}** von **CHF ${total.toFixed(2)}** ‚Ä¢ Rest: **CHF ${remaining.toFixed(2)}**`);
        } else {
          const remaining = Math.max(0, total - newSpent);
          const pct = Math.round(newPct*100);
          pushAI(`Status **${category}**: Verbraucht **CHF ${newSpent.toFixed(2)}** / **CHF ${total.toFixed(2)}** (${pct}%), Rest **CHF ${remaining.toFixed(2)}**`);
        }
      }

      render();
    }

    function crossedThreshold(prevPct, newPct){
      const levels = [0.5, 0.8, 1.0];
      for(const lvl of levels){
        if((prevPct==null || prevPct < lvl) && newPct >= lvl){
          return lvl;
        }
      }
      if((prevPct==null || prevPct <= 1.0) && newPct > 1.0) return 1.0;
      return null;
    }

    function renderEntries(n=10){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      const arr = (chat.entries||[]).slice(-n);
      if(arr.length===0) return 'Keine Eintr√§ge vorhanden. F√ºge z.B. *‚ÄûMigros 18.40 #Lebensmittel‚Äú* hinzu.';
      let out = 'Letzte Eintr√§ge:\\n';
      arr.forEach((e,i)=>{
        out += `${i+1}. ${e.label} ‚Äì CHF ${e.amount.toFixed(2)} [${e.category}] (${fmtDate(e.ts)})\\n`;
      });
      return out.trim();
    }

    function renderEntry(idx){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      const arr = chat.entries||[];
      if(idx<1 || idx>arr.length) return `Eintrag ${idx} existiert nicht (1..${arr.length}).`;
      const e = arr[idx-1];
      return `Eintrag ${idx}: **${e.label}** ‚Äì **CHF ${e.amount.toFixed(2)}**\\nKategorie: ${e.category}\\nDatum: ${fmtDate(e.ts)}`;
    }

    function deleteEntry(idx){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      const arr = chat.entries||[];
      if(idx<1 || idx>arr.length) return `Eintrag ${idx} existiert nicht (1..${arr.length}).`;
      const [removed] = arr.splice(idx-1,1);
      save(); render();
      return `Gel√∂scht: ${removed.label} ‚Äì CHF ${removed.amount.toFixed(2)} (${removed.category}). Jetzt ${(arr||[]).length}/10 Eintr√§ge.`;
    }

    function sumEntries(){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      const arr = chat.entries||[];
      const sum = arr.reduce((s,e)=>s+Number(e.amount||0),0);
      return `Summe der gespeicherten Eintr√§ge: **CHF ${sum.toFixed(2)}** (${arr.length}/10 Eintr√§ge).`;
    }

    function listCategories(){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      const arr = chat.entries||[];
      const cats = [...new Set(arr.map(e=>e.category))];
      if(cats.length===0) return 'Noch keine Kategorien.';
      return 'Kategorien: ' + cats.map(c=>c).join(', ');
    }

    function sumByCategory(){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      const arr = chat.entries||[];
      if(arr.length===0) return 'Keine Eintr√§ge vorhanden.';
      const map = {};
      arr.forEach(e=> map[e.category] = (map[e.category]||0) + Number(e.amount||0));
      const lines = Object.entries(map).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${k}: CHF ${v.toFixed(2)}`);
      return 'Summe nach Kategorie:\\n' + lines.join('\\n');
    }

    function monthIndexFromGerman(s){
      const m = {
        'jan':0,'januar':0,
        'feb':1,'februar':1,
        'm√§r':2,'maerz':2,'m√§rz':2,
        'apr':3,'april':3,
        'mai':4,
        'jun':5,'juni':5,
        'jul':6,'juli':6,
        'aug':7,'august':7,
        'sep':8,'sept':8,'september':8,
        'okt':9,'oktober':9,
        'nov':10,'november':10,
        'dez':11,'dezember':11
      };
      const k = s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace('.', '');
      return (k in m) ? m[k] : -1;
    }

    function renderMonthSummary(monthIdx, year){
      const chat = activeChat(); if(!chat) return pushAIWithTyping('Kein aktives Budget.');
      const arr = (chat.entries||[]).filter(e=>{
        const d = new Date(e.ts);
        return d.getMonth()===monthIdx && d.getFullYear()===year;
      });
      if(arr.length===0) return pushAIWithTyping('Keine Eintr√§ge f√ºr diesen Monat.');
      const map = {};
      let sum = 0;
      arr.forEach(e=>{ map[e.category]=(map[e.category]||0)+Number(e.amount||0); sum+=Number(e.amount||0); });
      const items = Object.entries(map).sort((a,b)=>b[1]-a[1]);
      const lines = items.map(([k,v])=>`${k}: CHF ${v.toFixed(2)}`);
      const title = `Ausgaben ${monthNameDE(monthIdx)} ${year}: **CHF ${sum.toFixed(2)}**`;
      pushAIWithTyping(title + '\\n' + lines.join('\\n'), 400);
      setTimeout(()=>{
        const svg = buildBarChartSVG(items);
        pushAI(svg);
      }, 450);
    }

    function monthNameDE(i){
      return ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'][i]||'';
    }

    function buildBarChartSVG(items){
      const chat = activeChat();
      const budgets = (chat && chat.budgets) ? chat.budgets : {};
      const max = Math.max(...items.map(i=>i[1]));
      const width = 640, padding = 14, barH = 28, gap = 10;
      const h = padding*2 + items.length*barH + (items.length-1)*gap + 30;
      let y = padding + 20;
      const parts = [];
      parts.push(`<div class="chart-wrap"><svg viewBox="0 0 ${width} ${h}" role="img" aria-label="Kategorie-Chart">`);
      parts.push(`<rect x="0" y="0" width="${width}" height="${h}" fill="#0b1220"/>`);
      parts.push(`<text x="${padding}" y="${padding+12}" fill="#9fb3d1" font-size="12">Ausgaben nach Kategorie</text>`);
      items.forEach(([k,v])=>{
        const w = Math.max(4, Math.round((v/max)*(width - padding*2 - 80)));
        const x = padding + 80;
        let color = colorForCategory(k);
        const total = budgets[k];
        if (total && total > 0) {
          const pct = v/total;
          if (pct >= 0.8) { color = '#f87171'; } // RED when >=80%
        }
        parts.push(`<text x="${padding}" y="${y+18}" fill="#c8e3ff" font-size="12">${escapeHTML(k)}</text>`);
        parts.push(`<rect x="${x}" y="${y}" rx="6" ry="6" width="${w}" height="${barH}" fill="${color}" opacity="0.9"/>`);
        parts.push(`<text x="${x+w+6}" y="${y+18}" fill="#9fb3d1" font-size="12">CHF ${v.toFixed(2)}</text>`);
        y += barH + gap;
      });
      parts.push(`</svg></div>`);
      return parts.join('');
    }
      parts.push(`</svg></div>`);
      return parts.join('');
    }
    function colorForCategory(cat){
      const idx = Math.abs(hashCode(cat)) % COLORS.length;
      return COLORS[idx];
    }
    function hashCode(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return h; }

    const send = ()=>{
      const val = inputEl.value.trim();
      if(!val || inputDisabled) return;
      setInputDisabled(true);
      const toSend = inputEl.value;
      inputEl.value='';
      setTimeout(()=> { pushUser(toSend); focusComposer(); }, 10);
    };
    sendBtn.addEventListener('click', ()=>{ if(!sendBtn.classList.contains('disabled')) send(); });

    addBtn.addEventListener('click', ()=>fileInput.click());
    fileInput.addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files||[]);
      if(!files.length) return;
      const attachments = [];
      for(const f of files){
        if(!f.type.startsWith('image/')) continue;
        const data = await fileToDataURL(f);
        attachments.push({name:f.name, data});
      }
      pushUser('Beleg hochgeladen', attachments);
      e.target.value = '';
    });
    const fileToDataURL = (file)=> new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); });

    avatarBtn.addEventListener('click', ()=>{ authModal.style.display='grid'; nameInput.value = state.user?.name || ''; nameInput.focus(); });
    cancelAuth.addEventListener('click', ()=>authModal.style.display='none');
    confirmAuth.addEventListener('click', ()=>{
      const name = nameInput.value.trim() || 'Demo User';
      const canvas = document.createElement('canvas'); canvas.width=64; canvas.height=64;
      const ctx = canvas.getContext('2d'); const g = ctx.createLinearGradient(0,0,64,64); g.addColorStop(0,'#22d3ee'); g.addColorStop(1,'#7c3aed'); ctx.fillStyle=g; ctx.fillRect(0,0,64,64);
      state.user = {name, photo: canvas.toDataURL('image/png')}; save(); updateAvatar(); authModal.style.display='none';
    });

    closeStatusSheet.addEventListener('click', closeStatus);
    (function init(){
      updateAvatar();
      if(!state.activeId){
        if(state.chats.length){
          state.chats.forEach(c=>{ if(!c.budgets) c.budgets = {}; });
          state.activeId = state.chats[0].id;
        } else {
          const id = uid();
          state.chats.push({id, title:'', createdAt:Date.now(), msgs:[], entries:[], receipts:[], budgets:{}});
          state.activeId = id;
          pushAI("Willkommen! Neues Budget erstellt. F√ºge Ausgaben wie ‚ÄûMigros 18.40 #Lebensmittel‚Äú hinzu.");
        }
        save();
      }
      render();
    })();

    window.monee = {
      reset(){
        localStorage.removeItem('monee_user');
        localStorage.removeItem('monee_chats_v4');
        localStorage.removeItem('monee_active');
        location.reload();
      }
    };
  </script>
</body>
</html>
