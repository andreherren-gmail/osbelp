<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Monee ‚Äì Budget Chat</title>
  <meta name="theme-color" content="#0b0f17">
  <style>
    :root{
      --bg:#0b0f17;
      --layer:#0a0f1a;
      --panel:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --brand:#22d3ee;
      --bubble-user:#1f2937;
      --bubble-ai:#0b1220;
      --ring:#22d3ee55;
      --border:#1f2937;
      --shadow:0 8px 24px rgba(0,0,0,.25);
      --money:#22c55e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:linear-gradient(180deg,var(--bg),#0a0f1a 40%, var(--bg) 100%);
      color:var(--text);
    }
    /* Appbar */
    .appbar{
      position:sticky; top:0; z-index:40;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:10px 12px env(safe-area-inset-top) 10px;
      background:rgba(9,13,20,.7); backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid #121826;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .brand .logo{width:26px;height:26px;border-radius:8px;background:radial-gradient(120% 120% at 0% 0%, var(--brand), #60a5fa 60%, #7c3aed)}
    .brand .title{font-weight:700;letter-spacing:.2px}
    .pill{font-size:12px;color:var(--muted);padding:2px 8px;border:1px solid #223045;border-radius:999px}
    .actions{display:flex; align-items:center; gap:8px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#0d1524;color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer}
    .btn.ghost{background:transparent}
    .avatar{width:34px;height:34px;border-radius:50%;border:1px solid var(--border);display:grid;place-items:center;background:#0c1426;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    /* Drawer */
    .drawer{
      position:fixed; inset:0 auto 0 0; width:min(86%,360px); background:#0b1220; border-right:1px solid #141c2e;
      transform:translateX(-100%); transition:.25s transform ease; z-index:60; display:flex; flex-direction:column;
    }
    .drawer.open{transform:translateX(0)}
    .drawer-header{padding:14px;border-bottom:1px solid #141c2e;display:flex;align-items:center;justify-content:space-between}
    .drawer-list{overflow:auto;-webkit-overflow-scrolling:touch;padding:8px 8px 96px}
    .chat-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer;border:1px solid transparent}
    .chat-item:hover{background:#0f172a;border-color:#1f2937}
    .chat-item.active{background:#0f172a;border-color:#283245}
    /* Main chat column */
    .wrap{min-height:100%;display:flex;flex-direction:column}
    .chat{
      flex:1; overflow:auto;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;
      padding:12px 12px 120px;
    }
    .container{max-width:760px;margin:0 auto}
    .msg{display:flex;gap:10px;margin:12px 0}
    .msg .bubble{padding:12px 14px;border-radius:16px;border:1px solid var(--border);line-height:1.55}
    .msg.user .bubble{background:var(--bubble-user)}
    .msg.ai .bubble{background:var(--bubble-ai)}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}
    .attachments{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .attachment{width:88px;height:88px;border-radius:10px;border:1px solid #253146;overflow:hidden;background:#0c1426;display:grid;place-items:center}
    .attachment img{width:100%;height:100%;object-fit:cover}
    /* Empty */
    .empty{margin:12vh auto 0;max-width:640px;text-align:center;color:var(--muted)}
    .empty h2{color:#e5e7eb;font-size:20px;margin:0 0 8px}
    .tips{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:16px}
    .tip{padding:10px;border:1px dashed #263245;border-radius:12px;color:#cbd5e1;background:linear-gradient(180deg,#0d1526,#0a101c)}
    @media(min-width:720px){.tips{grid-template-columns:repeat(4,1fr)}}
    /* Composer */
    .composer{
      position:fixed;left:0;right:0;bottom:0;z-index:40;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      background:linear-gradient(180deg, rgba(10,14,22,0), rgba(10,14,22,.85) 30%, rgba(10,14,22,.95));
      display:grid;place-items:center;
    }
    .composer-inner{
      width:100%;max-width:780px;display:flex;align-items:flex-end;gap:8px;
      background:#0c1426;border:1px solid var(--border);border-radius:20px;padding:8px;
      box-shadow:0 0 0 2px transparent;transition:.15s box-shadow ease,.15s border-color ease;
    }
    .composer-inner:focus-within{box-shadow:0 0 0 2px var(--ring)}
    .icon-btn{display:grid;place-items:center;width:40px;height:40px;border-radius:12px;border:1px solid #1e293b;background:#0a1222;cursor:pointer}
    .hidden-input{display:none}
    textarea{flex:1;resize:none;max-height:28vh;min-height:40px;background:transparent;border:none;color:var(--text);font-size:15px;line-height:1.5;outline:none;padding:8px 6px}
    textarea:disabled{opacity:.6;cursor:not-allowed}
    /* Typing indicator */
    .typing .bubble{display:inline-flex;gap:8px;align-items:center}
    .dollar{display:inline-block;font-weight:700;color:var(--money);opacity:.2;transform:translateY(0) scale(1);animation:blink .9s infinite}
    .dollar:nth-child(2){animation-delay:.15s}
    .dollar:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%,100%{opacity:.2; transform:translateY(0) scale(1)}50%{opacity:1; transform:translateY(-2px) scale(1.06)}}
  </style>
</head>
<body>
  <!-- Drawer -->
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-header">
      <strong>Budgets</strong>
      <button class="btn ghost" id="closeDrawer" aria-label="Schliessen">‚úï</button>
    </div>
    <div class="drawer-list" id="chatList"></div>
    <div style="padding:12px;">
      <button class="btn" id="newChatBtn2">Ôºã Neues Budget</button>
    </div>
  </aside>

  <!-- App Bar -->
  <header class="appbar">
    <div class="brand">
      <button class="btn ghost" id="openDrawer" aria-label="Budgets"><span>‚â°</span></button>
      <div class="logo" aria-hidden="true"></div>
      <div class="title">Monee</div>
      <span class="pill" id="activeBudgetPill">Kein Budget</span>
      <span class="pill" id="entryCounter">0/10</span>
    </div>
    <div class="actions">
      <button class="btn" id="newChatBtn">Ôºã Neues Budget</button>
      <button class="avatar" id="avatarBtn" title="Anmelden">
        <img id="avatarImg" alt="" />
        <span id="avatarFallback" aria-hidden="true">üë§</span>
      </button>
    </div>
  </header>

  <!-- Main -->
  <main class="wrap">
    <section class="chat">
      <div class="container" id="chatContainer">
        <div class="empty" id="emptyState">
          <h2>Neues Budget im Chat starten</h2>
          <p>Gib z.B. ein: <em>‚ÄûMigros 18.40‚Äú</em> oder lade einen Beleg √ºber <strong>Ôºã</strong> hoch.</p>
          <div class="tips">
            <div class="tip">‚ÄûZeige Eintr√§ge‚Äú ‚Äì listet die letzten 10</div>
            <div class="tip">‚ÄûSumme‚Äú ‚Äì Summe der gespeicherten Eintr√§ge</div>
            <div class="tip">‚ÄûZeige Eintrag 3‚Äú ‚Äì Detail</div>
            <div class="tip">‚ÄûL√∂sche Eintrag 2‚Äú ‚Äì entfernt Nummer 2</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Composer -->
  <div class="composer">
    <div class="composer-inner">
      <button class="icon-btn" id="addBtn" title="Beleg/Foto">Ôºã</button>
      <input class="hidden-input" id="fileInput" type="file" accept="image/*" multiple capture="environment">
      <textarea id="input" rows="1" placeholder="Schreibe eine Ausgabe (z.B. ‚ÄûB√§ckerei 4.60‚Äú) oder einen Befehl (z.B. ‚ÄûZeige Eintr√§ge‚Äú)" aria-label="Nachricht" enterkeyhint="send" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"></textarea>
      <!-- Enter = send, Shift+Enter = newline; no send button -->
    </div>
    <small style="display:block;text-align:center;color:var(--muted);margin-top:8px">
      Enter: senden ‚Ä¢ Shift+Enter: Zeile ‚Ä¢ Prototyp speichert lokal (max. 10 Eintr√§ge)
    </small>
  </div>

  <!-- Modal: Sign in -->
  <div class="modal" id="authModal" role="dialog" aria-modal="true" aria-labelledby="authTitle" style="position:fixed;inset:0;display:none;place-items:center;z-index:80;background:rgba(5,8,13,.6);backdrop-filter:blur(6px)">
    <div class="card" style="width:min(92vw,420px);background:#0b1220;border:1px solid #1c2436;border-radius:16px;padding:16px;box-shadow:var(--shadow)">
      <h3 id="authTitle">Anmelden</h3>
      <p>Demo-Login (lokal):</p>
      <div class="row" style="display:flex;gap:10px;align-items:center">
        <div class="avatar" style="width:32px;height:32px;display:grid;place-items:center;border:1px solid var(--border);background:#0c1426;border-radius:50%">üßë‚Äçüíª</div>
        <input id="nameInput" placeholder="Name" style="flex:1;background:#0a1222;border:1px solid #1f2937;border-radius:10px;color:var(--text);padding:8px 10px">
      </div>
      <div class="row" style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" id="cancelAuth">Abbrechen</button>
        <button class="btn" id="confirmAuth">Anmelden</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));

    const state = {
      user: JSON.parse(localStorage.getItem('monee_user')||'null'),
      chats: JSON.parse(localStorage.getItem('monee_chats_v2')||'[]'), // [{id,title,createdAt,msgs:[],entries:[],receipts:[]}]
      activeId: localStorage.getItem('monee_active') || null
    };

    const save = ()=>{
      localStorage.setItem('monee_user', JSON.stringify(state.user));
      localStorage.setItem('monee_chats_v2', JSON.stringify(state.chats));
      localStorage.setItem('monee_active', state.activeId||'');
    };
    const uid = ()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
    const activeChat = ()=> state.chats.find(c=>c.id===state.activeId) || null;
    const fmtDate = (ts)=> new Date(ts).toLocaleString(undefined,{dateStyle:'medium', timeStyle:'short'});
    const escapeHTML = (s)=> s.replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;' }[m]));
    const autolink = (s)=> s.replace(/(https?:\\/\\/[^\\s)]+)|(CHF\\s*\\d+(?:[\\.,]\\d{2})?|\\d+(?:[\\.,]\\d{2})?\\s*CHF)/gi, '<u>$1$2</u>');

    // UI refs
    const chatContainer = $('#chatContainer');
    const chatScroller = document.querySelector('.chat');
    const inputEl = $('#input');
    const fileInput = $('#fileInput');
    const addBtn = $('#addBtn');
    const avatarBtn = $('#avatarBtn');
    const authModal = $('#authModal');
    const cancelAuth = $('#cancelAuth');
    const confirmAuth = $('#confirmAuth');
    const nameInput = $('#nameInput');
    const avatarImg = $('#avatarImg');
    const avatarFallback = $('#avatarFallback');
    const openDrawer = $('#openDrawer');
    const closeDrawer = $('#closeDrawer');
    const drawer = $('#drawer');
    const chatList = $('#chatList');
    const newChatBtn = $('#newChatBtn');
    const newChatBtn2 = $('#newChatBtn2');
    const budgetPill = $('#activeBudgetPill');
    const entryCounter = $('#entryCounter');
    const emptyState = $('#emptyState');

    let inputDisabled = false;
    let allowNewline = false; // set only when Shift+Enter
    let pendingSend = false;

    /* ---------- Helpers ---------- */
    const ensureScroll = ()=>{ chatScroller.scrollTop = chatScroller.scrollHeight; };
    const setInputDisabled = (on)=>{ inputDisabled = !!on; inputEl.disabled = on; };
    const focusComposer = ()=>{ if(!inputDisabled){ inputEl.focus(); setTimeout(()=>inputEl.focus(),0); } };

    const updateAvatar = ()=>{
      if(state.user && state.user.photo){
        avatarImg.src = state.user.photo;
        avatarImg.style.display='block';
        avatarFallback.style.display='none';
      }else{
        avatarImg.removeAttribute('src');
        avatarImg.style.display='none';
        avatarFallback.style.display='grid';
      }
    };

    /* ---------- Drawer ---------- */
    const renderDrawer = ()=>{
      chatList.innerHTML = '';
      if(state.chats.length===0){
        const div = document.createElement('div');
        div.style.color='var(--muted)';
        div.style.padding='12px';
        div.textContent='Noch keine Budgets.';
        chatList.appendChild(div);
        return;
      }
      state.chats.slice().sort((a,b)=>b.createdAt-a.createdAt).forEach(c=>{
        const el = document.createElement('div');
        el.className = 'chat-item'+(c.id===state.activeId?' active':'');
        const entriesCount = (c.entries||[]).length;
        el.innerHTML = `
          <div class="avatar" style="width:30px;height:30px">üí¨</div>
          <div style="flex:1">
            <div style="font-weight:600">${escapeHTML(c.title||'Neues Budget')}</div>
            <div class="meta" style="color:var(--muted)">${fmtDate(c.createdAt)} ‚Ä¢ ${entriesCount}/10</div>
          </div>
          <button class="btn ghost" data-act="rename" style="padding:6px 8px">‚úé</button>
        `;
        el.addEventListener('click',(e)=>{
          if(e.target.dataset.act==='rename'){
            e.stopPropagation();
            const title = prompt('Budget umbenennen:', c.title||'');
            if(title!=null){ c.title = title.trim()||''; save(); render(); }
            return;
          }
          openChat(c.id); drawer.classList.remove('open');
        });
        chatList.appendChild(el);
      });
    };
    openDrawer.addEventListener('click', ()=>{drawer.classList.add('open'); renderDrawer()});
    closeDrawer.addEventListener('click', ()=>drawer.classList.remove('open'));

    /* ---------- Chats ---------- */
    const newChat = ()=>{
      const id = uid();
      state.chats.push({id, title:'', createdAt:Date.now(), msgs:[], entries:[], receipts:[]});
      state.activeId = id;
      save(); render(); focusComposer();
      pushAIWithTyping("Willkommen! Neues Budget erstellt. F√ºge Ausgaben wie *‚ÄûMigros 18.40‚Äú* hinzu. Maximal 10 Eintr√§ge werden gespeichert. Tippe **Hilfe** f√ºr Befehle.");
    };
    const openChat = (id)=>{ state.activeId = id; save(); render(); };

    newChatBtn.addEventListener('click', newChat);
    newChatBtn2.addEventListener('click', newChat);

    /* ---------- Render ---------- */
    const render = ()=>{
      const chat = activeChat();
      chatContainer.innerHTML='';
      if(!chat || (chat.msgs.length===0)){
        chatContainer.appendChild(emptyState); emptyState.style.display='block';
      }else{
        emptyState.style.display='none';
        chat.msgs.forEach(m=>{
          const row = document.createElement('div');
          row.className = 'msg '+(m.role==='user'?'user':'ai');
          row.innerHTML = `
            <div class="avatar" style="width:28px;height:28px">${m.role==='user'?(state.user?.name?.[0]?.toUpperCase()||'üßë'):'ü§ñ'}</div>
            <div style="flex:1">
              <div class="bubble">${autolink(escapeHTML(m.text)).replace(/\\n/g,'<br>')}</div>
              <div class="meta">${fmtDate(m.ts)}</div>
              ${m.attachments?.length? `<div class="attachments">${m.attachments.map(a=>`<div class="attachment"><img alt="Beleg" src=\"${a.data}\"></div>`).join('')}</div>`:''}
            </div>`;
          chatContainer.appendChild(row);
        });
      }
      const count = chat ? (chat.entries||[]).length : 0;
      budgetPill.textContent = chat ? (chat.title || 'Unbenanntes Budget') : 'Kein Budget';
      entryCounter.textContent = `${count}/10`;
      renderDrawer();
      ensureScroll();
    };

    const pushUser = (text, attachments=[])=>{
      const chat = activeChat(); if(!chat){ newChat(); return pushUser(text,attachments); }
      chat.msgs.push({role:'user', text, ts:Date.now(), attachments});
      save(); render();
      handleCommandOrEntry(text);
    };
    const pushAI = (text)=>{
      const chat = activeChat(); if(!chat) return;
      chat.msgs.push({role:'ai', text, ts:Date.now()}); save(); render();
    };

    /* ---------- Typing ---------- */
    function showTyping(){
      const row = document.createElement('div');
      row.className = 'msg ai typing';
      row.innerHTML = `
        <div class="avatar" style="width:28px;height:28px">ü§ñ</div>
        <div style="flex:1">
          <div class="bubble">
            <span class="dollar">$</span><span class="dollar">$</span><span class="dollar">$</span>
          </div>
          <div class="meta">schreibt‚Ä¶</div>
        </div>`;
      chatContainer.appendChild(row);
      ensureScroll();
      return row;
    }
    function pushAIWithTyping(text, delay=600){
      setInputDisabled(true);
      const typingEl = showTyping();
      setTimeout(()=>{
        typingEl.remove();
        pushAI(text);
        setInputDisabled(false);
        focusComposer();
      }, delay);
    }

    /* ---------- Commands & Entries ---------- */
    function handleCommandOrEntry(text){
      const t = text.trim();
      const low = t.toLowerCase();
      // Commands
      const mShow = low.match(/^zeige (?:eintr[a√§]ge|entries)(?:\\s+(\\d+))?/);
      const mShowOne = low.match(/^zeige eintrag\\s+(\\d+)/);
      const mDelete = low.match(/^l[√∂o]sche eintrag\\s+(\\d+)/);
      const mSum = low.match(/^summe(?:\\s+(monat|woche))?/);
      const mHelp = low.match(/^hilfe$/);

      if(mHelp){ return pushAIWithTyping(helpText()); }
      if(mShow){
        const n = parseInt(mShow[1]||'10',10);
        return pushAIWithTyping(renderEntries(n));
      }
      if(mShowOne){
        const idx = parseInt(mShowOne[1],10);
        return pushAIWithTyping(renderEntry(idx));
      }
      if(mDelete){
        const idx = parseInt(mDelete[1],10);
        return pushAIWithTyping(deleteEntry(idx));
      }
      if(mSum){
        return pushAIWithTyping(sumEntries());
      }

      // Else: parse as entry
      const amountMatch = t.match(/(\\d+[.,]\\d{1,2}|\\d+)/);
      const amount = amountMatch ? parseFloat(amountMatch[1].replace(',','.')) : NaN;
      if(!isNaN(amount)){
        const label = t.replace(amountMatch[1], '').trim() || 'Ausgabe';
        return addEntry(label, amount);
      }
      return pushAIWithTyping('Verstanden. (Befehl oder Betrag nicht erkannt ‚Äì tippe **Hilfe** f√ºr Beispiele)');
    }

    function helpText(){
      return [
        'Befehle:',
        '‚Ä¢ **Zeige Eintr√§ge** ‚Äì listet die gespeicherten Eintr√§ge (max. 10)',
        '‚Ä¢ **Zeige Eintr√§ge 5** ‚Äì zeigt die letzten 5',
        '‚Ä¢ **Zeige Eintrag 3** ‚Äì Detailansicht des dritten Eintrags',
        '‚Ä¢ **L√∂sche Eintrag 2** ‚Äì entfernt den zweiten Eintrag',
        '‚Ä¢ **Summe** ‚Äì Summe aller gespeicherten Eintr√§ge',
        '',
        'Ausgabe hinzuf√ºgen: *‚ÄûMigros 18.40‚Äú*, *‚ÄûB√§ckerei 4.60‚Äú*'
      ].join('\\n');
    }

    function addEntry(label, amount){
      const chat = activeChat(); if(!chat) return;
      chat.entries = chat.entries || [];
      const entry = { id: uid(), ts: Date.now(), label, amount };
      chat.entries.push(entry);
      if(chat.entries.length>10){ chat.entries = chat.entries.slice(-10); }
      save();
      const left = 10 - chat.entries.length;
      pushAIWithTyping(`Notiert: **${escapeHTML(label)} ‚Äì CHF ${amount.toFixed(2)}**.\\nEs sind jetzt **${chat.entries.length}/10** Eintr√§ge gespeichert.${left?` (noch ${left} frei)`:''}`);
      render();
    }

    function renderEntries(n=10){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      const arr = (chat.entries||[]).slice(-n);
      if(arr.length===0) return 'Keine Eintr√§ge vorhanden. F√ºge z.B. *‚ÄûMigros 18.40‚Äú* hinzu.';
      let out = 'Letzte Eintr√§ge:\\n';
      arr.forEach((e,i)=>{
        out += `${i+1}. ${e.label} ‚Äì CHF ${e.amount.toFixed(2)} (${fmtDate(e.ts)})\\n`;
      });
      return out.trim();
    }

    function renderEntry(idx){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      const arr = chat.entries||[];
      if(idx<1 || idx>arr.length) return `Eintrag ${idx} existiert nicht (1..${arr.length}).`;
      const e = arr[idx-1];
      return `Eintrag ${idx}: **${e.label}** ‚Äì **CHF ${e.amount.toFixed(2)}**\\nDatum: ${fmtDate(e.ts)}`;
    }

    function deleteEntry(idx){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      const arr = chat.entries||[];
      if(idx<1 || idx>arr.length) return `Eintrag ${idx} existiert nicht (1..${arr.length}).`;
      const [removed] = arr.splice(idx-1,1);
      save(); render();
      return `Gel√∂scht: ${removed.label} ‚Äì CHF ${removed.amount.toFixed(2)}. Jetzt ${(arr||[]).length}/10 Eintr√§ge.`;
    }

    function sumEntries(){
      const chat = activeChat(); if(!chat) return 'Kein aktives Budget.';
      const arr = chat.entries||[];
      const sum = arr.reduce((s,e)=>s+Number(e.amount||0),0);
      return `Summe der gespeicherten Eintr√§ge: **CHF ${sum.toFixed(2)}** (${arr.length}/10 Eintr√§ge).`;
    }

    /* ---------- Composer (newline & iOS guard) ---------- */
    // Guard A: keydown ‚Äî detect Enter (incl. legacy keyCode) and send unless Shift
    inputEl.addEventListener('keydown', (e)=>{
      const isEnter = e.key === 'Enter' || e.keyCode === 13;
      if(isEnter){
        if(e.shiftKey){ allowNewline = true; return; }
        allowNewline = false;
        e.preventDefault();
        pendingSend = true;
      }
    });
    // Guard B: beforeinput ‚Äî iOS inserts 'insertLineBreak' or 'insertParagraph'
    inputEl.addEventListener('beforeinput', (e)=>{
      const t = e.inputType;
      if((t === 'insertParagraph' || t === 'insertLineBreak') && !allowNewline){
        e.preventDefault();
        send();
      }
    });
    // Guard C: input ‚Äî ultimate fallback if newline sneaks in
    inputEl.addEventListener('input', ()=>{
      // auto-grow
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, window.innerHeight*0.28) + 'px';
      if(!allowNewline && inputEl.value.includes('\n')){
        inputEl.value = inputEl.value.replace(/\n+/g,' ').trim();
        send();
      }
      if(pendingSend){
        pendingSend = false;
        send();
      }
    });
    // Guard D: keyup ‚Äî reset allowance
    inputEl.addEventListener('keyup', (e)=>{
      if(e.key==='Enter' || e.keyCode === 13){ allowNewline = false; }
    });

    const send = ()=>{
      const val = inputEl.value.trim();
      if(!val || inputDisabled) return;
      setInputDisabled(true);
      const toSend = inputEl.value; // preserve exact content
      inputEl.value='';
      inputEl.dispatchEvent(new Event('input'));
      setTimeout(()=> pushUser(toSend), 10);
    };

    /* ---------- Files ---------- */
    addBtn.addEventListener('click', ()=>fileInput.click());
    fileInput.addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files||[]);
      if(!files.length) return;
      const attachments = [];
      for(const f of files){
        if(!f.type.startsWith('image/')) continue;
        const data = await fileToDataURL(f);
        attachments.push({name:f.name, data});
      }
      pushUser('Beleg hochgeladen', attachments);
      e.target.value = '';
    });
    const fileToDataURL = (file)=> new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); });

    /* ---------- Auth ---------- */
    avatarBtn.addEventListener('click', ()=>{ authModal.style.display='grid'; nameInput.value = state.user?.name || ''; nameInput.focus(); });
    cancelAuth.addEventListener('click', ()=>authModal.style.display='none');
    confirmAuth.addEventListener('click', ()=>{
      const name = nameInput.value.trim() || 'Demo User';
      const canvas = document.createElement('canvas'); canvas.width=64; canvas.height=64;
      const ctx = canvas.getContext('2d'); const g = ctx.createLinearGradient(0,0,64,64); g.addColorStop(0,'#22d3ee'); g.addColorStop(1,'#7c3aed'); ctx.fillStyle=g; ctx.fillRect(0,0,64,64);
      state.user = {name, photo: canvas.toDataURL('image/png')}; save(); updateAvatar(); authModal.style.display='none';
    });

    /* ---------- Init ---------- */
    (function init(){
      updateAvatar();
      if(!state.activeId && state.chats.length){ state.activeId = state.chats[0].id; }
      render();
    })();

    /* ---------- Export helpers ---------- */
    window.monee = {
      reset(){
        localStorage.removeItem('monee_user');
        localStorage.removeItem('monee_chats_v2');
        localStorage.removeItem('monee_active');
        location.reload();
      },
      export(){
        const data = {user:state.user, chats:state.chats};
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='monee-backup.json'; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
      },
      import(file){
        const r = new FileReader();
        r.onload = ()=>{ try{
          const data = JSON.parse(r.result);
          state.user = data.user||null;
          state.chats = data.chats||[];
          state.activeId = state.chats[0]?.id || null;
          save(); render(); updateAvatar();
        }catch(e){ alert('Import fehlgeschlagen: '+e.message); } };
        r.readAsText(file);
      }
    };
  </script>
</body>
</html>
